"use strict";(()=>{var e={};e.id=813,e.ids=[813],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2819:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>U,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>S});var r={};a.r(r),a.d(r,{POST:()=>p});var n=a(3278),s=a(5002),i=a(4877),o=a(6660),u=a(1035),l=a(1309),m=a(8190);async function p(e){let t=await (0,o.f)(),{data:{user:a}}=await t.auth.getUser();if(!a)return l.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json().catch(()=>({})),n=r.characterId,s=r.size||"small";if(!n)return l.NextResponse.json({error:"characterId required"},{status:400});let i=await u._.user.findUnique({where:{id:a.id}}),p=await u._.character.findFirst({where:{id:n,userId:a.id},include:{user:!0}});if(!i||!p)return l.NextResponse.json({error:"Not found"},{status:404});let c=!!p.user?.premiumUntil&&p.user.premiumUntil>new Date,d=(0,m.YX)(c),{currentStamina:S,lastStaminaUpdate:h}=(0,m.bQ)({currentStamina:p.currentStamina,maxStamina:p.maxStamina,lastStaminaUpdate:p.lastStaminaUpdate,isVip:c}),x=0,U=0;if("small"===s)x=50,U=25;else if("medium"===s)x=90,U=50;else{if("large"!==s)return l.NextResponse.json({error:"size must be small|medium|large"},{status:400});x=150,U=100}if(i.gems<x)return l.NextResponse.json({error:"Недостаточно гемов"},{status:400});let f=Math.min(m.zU,S+U);return await u._.$transaction([u._.user.update({where:{id:a.id},data:{gems:i.gems-x}}),u._.character.update({where:{id:n},data:{currentStamina:f,lastStaminaUpdate:h}})]),l.NextResponse.json({ok:!0,currentStamina:f,maxStamina:d,gemsSpent:x})}let c=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/stamina/refill/route",pathname:"/api/stamina/refill",filename:"route",bundlePath:"app/api/stamina/refill/route"},resolvedPagePath:"/Users/artosetrov/Documents/Cursor AI/BumWars/app/api/stamina/refill/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:S,serverHooks:h}=c,x="/api/stamina/refill/route";function U(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:S})}},1035:(e,t,a)=>{a.d(t,{_:()=>n});var r=a(3524);let n=globalThis.prisma??new r.PrismaClient({log:["error"]})},8190:(e,t,a)=>{a.d(t,{YX:()=>o,bQ:()=>u,ou:()=>n,yv:()=>i,zU:()=>r});let r=200,n={PVP:10,DUNGEON_EASY:15,DUNGEON_NORMAL:20,DUNGEON_HARD:25,BOSS_RAID:40,SPECIAL_EVENT:30},s=e=>{let{currentStamina:t,maxStamina:a,lastStaminaUpdate:n,isVip:s}=e,i=s?a:Math.min(a,100);return t>=i?Math.min(t,r):Math.min(i,t+Math.floor((Date.now()-new Date(n).getTime())/72e4))},i=e=>{let{cost:t,isVip:a}=e,r=s({currentStamina:e.currentStamina,maxStamina:e.maxStamina,lastStaminaUpdate:e.lastStaminaUpdate,isVip:a});return r<t?{error:"Недостаточно стамины"}:{newStamina:r-t,newLastUpdate:new Date}},o=e=>e?120:100,u=e=>{let{maxStamina:t,isVip:a}=e,n=o(!!a),s=e.currentStamina,i=new Date(e.lastStaminaUpdate).getTime(),u=Date.now();return s<n&&(s=Math.min(n,s+Math.floor((u-i)/72e4))),{currentStamina:Math.min(s,r),lastStaminaUpdate:new Date(u)}}},6660:(e,t,a)=>{a.d(t,{f:()=>s});var r=a(7782),n=a(2845);let s=async()=>{let e=await (0,n.cookies)(),t=process.env.NEXT_PUBLIC_SUPABASE_URL,a=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!t||!a)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY");return(0,r.createServerClient)(t,a,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:a,options:r})=>e.set(t,a,r))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[787,833,228],()=>a(2819));module.exports=r})();