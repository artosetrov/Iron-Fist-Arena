"use strict";(()=>{var e={};e.id=156,e.ids=[156],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},217:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>U,patchFetch:()=>M,requestAsyncStorage:()=>x,routeModule:()=>y,serverHooks:()=>f,staticGenerationAsyncStorage:()=>P});var r={};a.r(r),a.d(r,{POST:()=>R});var n=a(3278),i=a(5002),s=a(4877),p=a(6660),l=a(1035),o=a(1309),d=a(8638);let u=(e,t)=>1/(1+Math.pow(10,(t-e)/400)),c=(e,t,a)=>Math.round(32*(a-u(e,t))),m=e=>e>=2100?"Grandmaster":e>=1900?"Master":e>=1700?"Diamond":e>=1500?"Platinum":e>=1300?"Gold":e>=1100?"Silver":"Bronze";var v=a(8190),h=a(875),g=a(8492),w=a(8330),S=a(1148);async function R(e){let t=await (0,p.f)(),{data:{user:a}}=await t.auth.getUser();if(!a)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=(await e.json().catch(()=>({}))).characterId;if(!r)return o.NextResponse.json({error:"characterId required"},{status:400});let n=await l._.character.findFirst({where:{id:r,userId:a.id},include:{user:!0}});if(!n)return o.NextResponse.json({error:"Character not found"},{status:404});let i=!!n.user?.premiumUntil&&n.user.premiumUntil>new Date,s=(0,v.yv)({currentStamina:n.currentStamina,maxStamina:n.maxStamina,lastStaminaUpdate:n.lastStaminaUpdate,cost:v.ou.PVP,isVip:i});if("error"in s)return o.NextResponse.json({error:s.error},{status:400});let u=await (0,h.E)(),R=await l._.character.findMany({where:{id:{not:r},userId:{not:a.id},pvpRating:{gte:n.pvpRating-100,lte:n.pvpRating+100}},take:10,orderBy:{pvpRating:"asc"}}),y=R[Math.floor(Math.random()*R.length)];if(y||(y=await l._.character.findFirst({where:{id:{not:r},userId:{not:a.id}}})??null),!y)return o.NextResponse.json({error:"Нет доступных противников. Попробуйте позже."},{status:503});let x=(0,d.U)({id:n.id,name:n.characterName,class:n.class,level:n.level,strength:n.strength,agility:n.agility,vitality:n.vitality,endurance:n.endurance,intelligence:n.intelligence,wisdom:n.wisdom,luck:n.luck,charisma:n.charisma,armor:n.armor}),P=(0,d.U)({id:y.id,name:y.characterName,class:y.class,level:y.level,strength:y.strength,agility:y.agility,vitality:y.vitality,endurance:y.endurance,intelligence:y.intelligence,wisdom:y.wisdom,luck:y.luck,charisma:y.charisma,armor:y.armor}),f=(0,d.a)(x,P,[]),U=f.winnerId,M=f.loserId,A=f.draw;n.id,x.id;let k=U===n.id,D=U===y.id,I=A?0:c(n.pvpRating,y.pvpRating,k?1:0),_=A?0:c(y.pvpRating,n.pvpRating,D?1:0),N=Math.max(0,n.pvpRating+I),b=Math.max(0,y.pvpRating+_),j=k?(0,g.kQ)(y.pvpRating,n.pvpWinStreak):(0,g.PD)(),L=D?(0,g.kQ)(n.pvpRating,y.pvpWinStreak):(0,g.PD)(),W=k?(0,g.MF)(g.yh.PVP_WIN,y.level):(0,g.MF)(g.yh.PVP_LOSS,y.level),q=D?(0,g.MF)(g.yh.PVP_WIN,n.level):(0,g.MF)(g.yh.PVP_LOSS,n.level);await l._.pvpMatch.create({data:{player1Id:n.id,player2Id:y.id,player1RatingBefore:n.pvpRating,player2RatingBefore:y.pvpRating,player1RatingAfter:N,player2RatingAfter:b,winnerId:U??n.id,loserId:M??y.id,combatLog:f.log,turnsTaken:f.turns,player1GoldReward:j,player2GoldReward:L,player1XpReward:W,player2XpReward:q,matchType:"ranked",seasonNumber:u}});let E=k?n.pvpWinStreak+1:0,F=D?y.pvpWinStreak+1:0,O=n.currentXp+W,X=n.gold+j,G=(0,w.A)({level:n.level,currentXp:O,statPointsAvailable:n.statPointsAvailable,gold:X,maxHp:n.maxHp});k&&await (0,S.m)(n.id,"pvp_wins",1),await l._.character.update({where:{id:n.id},data:{pvpRating:N,pvpWins:n.pvpWins+(k?1:0),pvpLosses:n.pvpLosses+(k?0:1),pvpWinStreak:E,highestPvpRank:m(N),gold:G.gold,currentXp:G.currentXp,level:G.level,statPointsAvailable:G.statPointsAvailable,currentHp:G.currentHp,currentStamina:s.newStamina,lastStaminaUpdate:s.newLastUpdate}});let V=(0,v.yv)({currentStamina:y.currentStamina,maxStamina:y.maxStamina,lastStaminaUpdate:y.lastStaminaUpdate,cost:v.ou.PVP,isVip:!1}),B="newStamina"in V?V.newStamina:y.currentStamina,H="newLastUpdate"in V?V.newLastUpdate:y.lastStaminaUpdate;return await l._.character.update({where:{id:y.id},data:{pvpRating:b,pvpWins:y.pvpWins+(D?1:0),pvpLosses:y.pvpLosses+(D?0:1),pvpWinStreak:F,highestPvpRank:m(b),gold:y.gold+L,currentXp:y.currentXp+q,currentStamina:B,lastStaminaUpdate:H}}),o.NextResponse.json({winnerId:f.winnerId,loserId:f.loserId,draw:f.draw,turns:f.turns,log:f.log,rewards:{gold:j,xp:W,ratingChange:I,newRating:N,won:k}})}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/pvp/find-match/route",pathname:"/api/pvp/find-match",filename:"route",bundlePath:"app/api/pvp/find-match/route"},resolvedPagePath:"/Users/artosetrov/Documents/Cursor AI/BumWars/app/api/pvp/find-match/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:P,serverHooks:f}=y,U="/api/pvp/find-match/route";function M(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:P})}},875:(e,t,a)=>{a.d(t,{E:()=>i});var r=a(1035);let n=async()=>{let e=new Date,t=await r._.season.findFirst({where:{startAt:{lte:e},endAt:{gte:e}},orderBy:{number:"desc"}});if(t)return{number:t.number};let a=(t=await r._.season.findFirst({orderBy:{number:"desc"}}))?t.number+1:1,n=new Date(e);n.setDate(1),n.setHours(0,0,0,0);let i=new Date(n);return i.setMonth(i.getMonth()+1),await r._.season.create({data:{number:a,startAt:n,endAt:i,theme:"Proving Grounds"}}),{number:a}},i=async()=>{let{number:e}=await n();return e}},8190:(e,t,a)=>{a.d(t,{YX:()=>p,bQ:()=>l,ou:()=>n,yv:()=>s,zU:()=>r});let r=200,n={PVP:10,DUNGEON_EASY:15,DUNGEON_NORMAL:20,DUNGEON_HARD:25,BOSS_RAID:40,SPECIAL_EVENT:30},i=e=>{let{currentStamina:t,maxStamina:a,lastStaminaUpdate:n,isVip:i}=e,s=i?a:Math.min(a,100);return t>=s?Math.min(t,r):Math.min(s,t+Math.floor((Date.now()-new Date(n).getTime())/72e4))},s=e=>{let{cost:t,isVip:a}=e,r=i({currentStamina:e.currentStamina,maxStamina:e.maxStamina,lastStaminaUpdate:e.lastStaminaUpdate,isVip:a});return r<t?{error:"Недостаточно стамины"}:{newStamina:r-t,newLastUpdate:new Date}},p=e=>e?120:100,l=e=>{let{maxStamina:t,isVip:a}=e,n=p(!!a),i=e.currentStamina,s=new Date(e.lastStaminaUpdate).getTime(),l=Date.now();return i<n&&(i=Math.min(n,i+Math.floor((l-s)/72e4))),{currentStamina:Math.min(i,r),lastStaminaUpdate:new Date(l)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[787,833,228,599],()=>a(217));module.exports=r})();