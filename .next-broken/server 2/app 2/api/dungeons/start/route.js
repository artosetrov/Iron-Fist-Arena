"use strict";(()=>{var e={};e.id=561,e.ids=[561],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4204:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>M,patchFetch:()=>U,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>S});var r={};a.r(r),a.d(r,{POST:()=>c});var n=a(3278),o=a(5002),s=a(4877),i=a(6660),u=a(1035),l=a(1309),m=a(8190),d=a(6844);let p={easy:m.ou.DUNGEON_EASY,normal:m.ou.DUNGEON_NORMAL,hard:m.ou.DUNGEON_HARD};async function c(e){let t=await (0,i.f)(),{data:{user:a}}=await t.auth.getUser();if(!a)return l.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json().catch(()=>({})),n=r.characterId,o=r.difficulty||"normal";if(!n||!["easy","normal","hard"].includes(o))return l.NextResponse.json({error:"characterId and difficulty (easy|normal|hard) required"},{status:400});let s=await u._.character.findFirst({where:{id:n,userId:a.id},include:{user:!0}});if(!s)return l.NextResponse.json({error:"Character not found"},{status:404});let c=p[o],h=(0,m.yv)({currentStamina:s.currentStamina,maxStamina:s.maxStamina,lastStaminaUpdate:s.lastStaminaUpdate,cost:c,isVip:!!s.user?.premiumUntil&&s.user.premiumUntil>new Date});if("error"in h)return l.NextResponse.json({error:h.error},{status:400});let x=Math.floor(1e6*Math.random()),S=(0,d.n)(1,x),f=(0,d.P)(s.level,1,o,S[0]),M=await u._.dungeonRun.create({data:{characterId:n,difficulty:o,currentFloor:1,state:{runId:"",characterId:n,difficulty:o,currentFloor:1,seed:x,rooms:S,roomIndex:0,enemyCurrentHp:f.maxHp,enemyMaxHp:f.maxHp,enemyStats:f,totalFloors:5,rewards:{gold:0,xp:0}},seed:x}}),U=M.state;return U.runId=M.id,await u._.dungeonRun.update({where:{id:M.id},data:{state:U}}),await u._.character.update({where:{id:n},data:{currentStamina:h.newStamina,lastStaminaUpdate:h.newLastUpdate}}),l.NextResponse.json({runId:M.id,currentFloor:1,room:S[0],enemy:{name:f.name,hp:f.maxHp,maxHp:f.maxHp}})}let h=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/dungeons/start/route",pathname:"/api/dungeons/start",filename:"route",bundlePath:"app/api/dungeons/start/route"},resolvedPagePath:"/Users/artosetrov/Documents/Cursor AI/BumWars/app/api/dungeons/start/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:S,serverHooks:f}=h,M="/api/dungeons/start/route";function U(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:S})}},1035:(e,t,a)=>{a.d(t,{_:()=>n});var r=a(3524);let n=globalThis.prisma??new r.PrismaClient({log:["error"]})},6844:(e,t,a)=>{a.d(t,{P:()=>i,n:()=>s});let r={easy:.7,normal:1,hard:1.4},n=e=>1+.15*e,o={combat:.6,treasure:.15,elite:.1,trap:.1,rest:.05,boss:0},s=(e,t)=>{let a=()=>(t=(9301*t+49297)%233280)/233280,r=5+2*e,n=[],s=["combat","treasure","elite","trap","rest"];for(let e=0;e<r-1;e++){let t=a();for(let e of s)if((t-=o[e])<=0){n.push(e);break}n.length<=e&&n.push("combat")}return n.push("boss"),n},i=(e,t,a,o)=>{let s=r[a]*n(t),i=Math.max(10,Math.floor(30+4*e)),u="boss"===o||"elite"===o,l=u?"boss"===o?2:1.3:1,m=Math.max(10,Math.floor(i*s*l*1.1)),d=Math.max(10,Math.floor(i*s*l*.85));return{strength:Math.max(10,Math.floor(i*s*l*.9)),agility:Math.max(10,Math.floor(i*s*.7)),vitality:m,endurance:d,intelligence:Math.max(10,Math.floor(i*s*.6)),wisdom:Math.max(10,Math.floor(i*s*.5)),luck:10,charisma:10,armor:Math.max(0,Math.floor(.8*d)),maxHp:Math.max(100,10*m),name:"boss"===o?`Босс этажа ${t}`:"elite"===o?"Элитный враг":"Враг",isBoss:u}}},8190:(e,t,a)=>{a.d(t,{YX:()=>i,bQ:()=>u,ou:()=>n,yv:()=>s,zU:()=>r});let r=200,n={PVP:10,DUNGEON_EASY:15,DUNGEON_NORMAL:20,DUNGEON_HARD:25,BOSS_RAID:40,SPECIAL_EVENT:30},o=e=>{let{currentStamina:t,maxStamina:a,lastStaminaUpdate:n,isVip:o}=e,s=o?a:Math.min(a,100);return t>=s?Math.min(t,r):Math.min(s,t+Math.floor((Date.now()-new Date(n).getTime())/72e4))},s=e=>{let{cost:t,isVip:a}=e,r=o({currentStamina:e.currentStamina,maxStamina:e.maxStamina,lastStaminaUpdate:e.lastStaminaUpdate,isVip:a});return r<t?{error:"Недостаточно стамины"}:{newStamina:r-t,newLastUpdate:new Date}},i=e=>e?120:100,u=e=>{let{maxStamina:t,isVip:a}=e,n=i(!!a),o=e.currentStamina,s=new Date(e.lastStaminaUpdate).getTime(),u=Date.now();return o<n&&(o=Math.min(n,o+Math.floor((u-s)/72e4))),{currentStamina:Math.min(o,r),lastStaminaUpdate:new Date(u)}}},6660:(e,t,a)=>{a.d(t,{f:()=>o});var r=a(7782),n=a(2845);let o=async()=>{let e=await (0,n.cookies)(),t=process.env.NEXT_PUBLIC_SUPABASE_URL,a=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!t||!a)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY");return(0,r.createServerClient)(t,a,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:a,options:r})=>e.set(t,a,r))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[787,833,228],()=>a(4204));module.exports=r})();