"use strict";(()=>{var e={};e.id=940,e.ids=[940],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6255:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>P,patchFetch:()=>F,requestAsyncStorage:()=>b,routeModule:()=>R,serverHooks:()=>I,staticGenerationAsyncStorage:()=>H});var a={};r.r(a),r.d(a,{POST:()=>M});var n=r(3278),o=r(5002),i=r(4877),l=r(6660),s=r(1035),d=r(1309),m=r(8638),u=r(6844);let c=[{rarity:"legendary",minRoll:990},{rarity:"epic",minRoll:960},{rarity:"rare",minRoll:900},{rarity:"uncommon",minRoll:750},{rarity:"common",minRoll:0}],p={easy:0,normal:50,hard:120},h=(e,t)=>{let r=Math.min(1200,Math.floor(1e3*Math.random())+1+(2*e+(p[t]??0)));for(let{rarity:e,minRoll:t}of c)if(r>=t)return e;return"common"},g=(e,t)=>!!t||Math.random()<("easy"===e?.6:"hard"===e?.7:.5);var x=r(8330),y=r(1148);let f={easy:[10,20],normal:[30,50],hard:[60,100]},v={easy:150,normal:400,hard:800},w={easy:80,normal:150,hard:250};async function M(e,{params:t}){let r=await (0,l.f)(),{data:{user:a}}=await r.auth.getUser();if(!a)return d.NextResponse.json({error:"Unauthorized"},{status:401});let{id:n}=await t,o=await s._.dungeonRun.findFirst({where:{id:n},include:{character:!0}});if(!o||o.character.userId!==a.id)return d.NextResponse.json({error:"Run not found"},{status:404});let i=o.state,c=o.character,p=(0,m.U)({id:c.id,name:c.characterName,class:c.class,level:c.level,strength:c.strength,agility:c.agility,vitality:c.vitality,endurance:c.endurance,intelligence:c.intelligence,wisdom:c.wisdom,luck:c.luck,charisma:c.charisma,armor:c.armor}),M=i.enemyStats,R=(0,m.U)({id:"enemy",name:M.name,class:"warrior",level:c.level,strength:M.strength,agility:M.agility,vitality:M.vitality,endurance:M.endurance,intelligence:M.intelligence,wisdom:M.wisdom,luck:M.luck,charisma:M.charisma,armor:M.armor});R.currentHp=i.enemyCurrentHp,R.maxHp=M.maxHp;let b=(0,m.a)(p,R,[]);if(b.winnerId!==c.id)return await s._.dungeonRun.delete({where:{id:n}}),d.NextResponse.json({victory:!1,log:b.log,message:"Поражение"});let H=i.difficulty,I=i.enemyStats.isBoss,[P,F]=f[H],j=I?v[H]:Math.floor(P+Math.random()*(F-P+1)),k=w[H]*i.currentFloor;i.rewards.gold+=j,i.rewards.xp+=k;let q=g(H,I)&&{rarity:h(c.luck,H),floor:i.currentFloor},A=null;if(q){let e=Math.max(1,c.level+Math.floor(6*Math.random())-2),t=q.rarity,r=await s._.item.findFirst({where:{rarity:t,itemLevel:{gte:e-1,lte:e+1}}});if(!r){let[a,n]={common:[5,15],uncommon:[12,25],rare:[20,45],epic:[40,80],legendary:[75,150]}[t];r=await s._.item.create({data:{itemName:`Добыча ${t}`,itemType:"weapon",rarity:t,itemLevel:e,baseStats:{strength:Math.floor(a+Math.random()*(n-a+1))},buyPrice:10*e*("legendary"===t?25:"epic"===t?10:"rare"===t?4:"uncommon"===t?2:1)}})}A=(await s._.equipmentInventory.create({data:{characterId:c.id,itemId:r.id}})).id}if(i.roomIndex++,i.roomIndex>=i.rooms.length&&(i.currentFloor++,i.roomIndex=0,i.rooms=(0,u.n)(i.currentFloor,i.seed)),i.currentFloor>i.totalFloors){await (0,y.m)(c.id,"dungeons_complete",1);let e=(0,x.A)({level:c.level,currentXp:c.currentXp+i.rewards.xp,statPointsAvailable:c.statPointsAvailable,gold:c.gold+i.rewards.gold,maxHp:c.maxHp});return await s._.character.update({where:{id:c.id},data:{gold:e.gold,currentXp:e.currentXp,level:e.level,statPointsAvailable:e.statPointsAvailable,currentHp:e.currentHp}}),await s._.dungeonRun.delete({where:{id:n}}),d.NextResponse.json({victory:!0,dungeonComplete:!0,log:b.log,rewards:i.rewards,droppedItem:q?{itemId:A,rarity:q.rarity}:null})}let _=i.rooms[i.roomIndex],C=(0,u.P)(c.level,i.currentFloor,H,_);return i.enemyStats=C,i.enemyCurrentHp=C.maxHp,i.enemyMaxHp=C.maxHp,await s._.dungeonRun.update({where:{id:n},data:{state:i}}),d.NextResponse.json({victory:!0,dungeonComplete:!1,log:b.log,goldEarned:j,xpEarned:k,droppedItem:q?{itemId:A,rarity:q.rarity}:null,next:{floor:i.currentFloor,room:_,enemy:{name:C.name,hp:C.maxHp,maxHp:C.maxHp}}})}let R=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/dungeons/run/[id]/fight/route",pathname:"/api/dungeons/run/[id]/fight",filename:"route",bundlePath:"app/api/dungeons/run/[id]/fight/route"},resolvedPagePath:"/Users/artosetrov/Documents/Cursor AI/BumWars/app/api/dungeons/run/[id]/fight/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:b,staticGenerationAsyncStorage:H,serverHooks:I}=R,P="/api/dungeons/run/[id]/fight/route";function F(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:H})}},6844:(e,t,r)=>{r.d(t,{P:()=>l,n:()=>i});let a={easy:.7,normal:1,hard:1.4},n=e=>1+.15*e,o={combat:.6,treasure:.15,elite:.1,trap:.1,rest:.05,boss:0},i=(e,t)=>{let r=()=>(t=(9301*t+49297)%233280)/233280,a=5+2*e,n=[],i=["combat","treasure","elite","trap","rest"];for(let e=0;e<a-1;e++){let t=r();for(let e of i)if((t-=o[e])<=0){n.push(e);break}n.length<=e&&n.push("combat")}return n.push("boss"),n},l=(e,t,r,o)=>{let i=a[r]*n(t),l=Math.max(10,Math.floor(30+4*e)),s="boss"===o||"elite"===o,d=s?"boss"===o?2:1.3:1,m=Math.max(10,Math.floor(l*i*d*1.1)),u=Math.max(10,Math.floor(l*i*d*.85));return{strength:Math.max(10,Math.floor(l*i*d*.9)),agility:Math.max(10,Math.floor(l*i*.7)),vitality:m,endurance:u,intelligence:Math.max(10,Math.floor(l*i*.6)),wisdom:Math.max(10,Math.floor(l*i*.5)),luck:10,charisma:10,armor:Math.max(0,Math.floor(.8*u)),maxHp:Math.max(100,10*m),name:"boss"===o?`Босс этажа ${t}`:"elite"===o?"Элитный враг":"Враг",isBoss:s}}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[787,833,228,599],()=>r(6255));module.exports=a})();