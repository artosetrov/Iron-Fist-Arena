"use strict";(()=>{var e={};e.id=527,e.ids=[527],e.modules={3524:e=>{e.exports=require("@prisma/client")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9970:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>l,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var a={};t.r(a),t.d(a,{POST:()=>d});var s=t(3278),o=t(5002),n=t(4877),i=t(6660),u=t(1035),p=t(1309);async function d(e){let r=await (0,i.f)(),{data:{user:t}}=await r.auth.getUser();if(!t)return p.NextResponse.json({error:"Unauthorized"},{status:401});let a=await e.json().catch(()=>({})),s=a.characterId,o=a.inventoryId;if(!s||!o)return p.NextResponse.json({error:"characterId, inventoryId required"},{status:400});let n=await u._.equipmentInventory.findFirst({where:{id:o,characterId:s},include:{item:!0,character:!0}});if(!n||n.character.userId!==t.id)return p.NextResponse.json({error:"Not found"},{status:404});if(n.upgradeLevel>=10)return p.NextResponse.json({error:"Уже максимальный уровень улучшения"},{status:400});let d=Math.max(1,Math.floor((n.item.buyPrice??100)*Math.pow(.2*(n.upgradeLevel+1),1.5)));if(n.character.gold<d)return p.NextResponse.json({error:"Недостаточно золота"},{status:400});let c=75-5*n.upgradeLevel,l=n.upgradeLevel,h=!1;if(100*Math.random()<c)l=n.upgradeLevel+1;else{let e=100*Math.random();e<50?l=n.upgradeLevel:e<80?l=Math.max(0,n.upgradeLevel-1):h=!0}return h?(await u._.$transaction([u._.equipmentInventory.delete({where:{id:o}}),u._.character.update({where:{id:s},data:{gold:n.character.gold-d}})]),p.NextResponse.json({ok:!0,success:!1,destroyed:!0,cost:d})):(await u._.$transaction([u._.equipmentInventory.update({where:{id:o},data:{upgradeLevel:l}}),u._.character.update({where:{id:s},data:{gold:n.character.gold-d}})]),p.NextResponse.json({ok:!0,success:l>n.upgradeLevel,newLevel:l,cost:d}))}let c=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/shop/upgrade/route",pathname:"/api/shop/upgrade",filename:"route",bundlePath:"app/api/shop/upgrade/route"},resolvedPagePath:"/Users/artosetrov/Documents/Cursor AI/BumWars/app/api/shop/upgrade/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:h,serverHooks:g}=c,v="/api/shop/upgrade/route";function x(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},1035:(e,r,t)=>{t.d(r,{_:()=>s});var a=t(3524);let s=globalThis.prisma??new a.PrismaClient({log:["error"]})},6660:(e,r,t)=>{t.d(r,{f:()=>o});var a=t(7782),s=t(2845);let o=async()=>{let e=await (0,s.cookies)(),r=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!r||!t)throw Error("Missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY");return(0,a.createServerClient)(r,t,{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:a})=>e.set(r,t,a))}catch{}}}})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[787,833,228],()=>t(9970));module.exports=a})();